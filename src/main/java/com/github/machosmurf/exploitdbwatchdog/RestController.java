package com.github.machosmurf.exploitdbwatchdog;

import org.aspectj.weaver.ast.Not;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import sun.reflect.generics.reflectiveObjects.NotImplementedException;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

@org.springframework.web.bind.annotation.RestController
public class RestController {

    private UserController userController;
    private ExploitController exploitController;
    private Exploitparser exploitparser;

    @Autowired
    public RestController(UserController userController,
                          ExploitController exploitController,
                          Exploitparser exploitparser) {
        this.userController = userController;
        this.exploitController = exploitController;
        this.exploitparser = exploitparser;
    }

    //TODO: Create consistent naming for endpoints

    @RequestMapping(value = "/Test", method = RequestMethod.GET)
    public List<Language> getLanguages(){
        return exploitController.getLanguageCount();
    }

    @RequestMapping(value = "/Stats", method = RequestMethod.GET)
    public Stats getDatabaseStats(){
        //return new Stats(DatabaseStats.getPorts(), DatabaseStats.getPlatforms(), DatabaseStats.getLanguages(), DatabaseStats.getTypes());
        throw new NotImplementedException();
    }

    @RequestMapping(value = "/Exploit/{id}", method = RequestMethod.GET)
    public Exploit getExploitById(@PathVariable int id) {
        return exploitController.getExploitById(id);
    }

    @RequestMapping(value = "/Exploit/Find/Author/{author}", method = RequestMethod.GET)
    public List<Exploit> getExploitByAuthor(@PathVariable String author) {
        return exploitController.getExploitsByAuthor(author);
    }

    @RequestMapping(value = "/Exploit/Find/Type/{type}", method = RequestMethod.GET)
    public List<Exploit> getExploitByType(@PathVariable String type) {
        return exploitController.getExploitsByType(type);
    }

    @RequestMapping(value = "/Exploit/Find/Platform/{platform}", method = RequestMethod.GET)
    public List<Exploit> getExploitByPlatform(@PathVariable String platform) {
        return exploitController.getExploitsByPlatform(platform);
    }

    @RequestMapping(value = "/Exploit/Find/{platform}/{tags}")
    public List<Exploit> searchExploitByPlatformAndTags(@PathVariable("platform") String platform, @PathVariable("tags") String tags) {
        List<String> soloTags = splitTags(tags);
        return exploitController.getExploitsByPlatformAndTags(platform, soloTags);
    }

    @RequestMapping(value = "/Exploit/Find/Tags/{tags}")
    public List<Exploit> searchExploitByTags(@PathVariable String tags) {
        List<String> soloTags = splitTags(tags);
        return exploitController.searchExploitByTags(soloTags);
    }

    @RequestMapping(value = "/Exploit/Find/Author/{author}")
    public List<Exploit> searchExploitByAuthor(@PathVariable String author) {
        return exploitController.getExploitsByAuthor(author);
    }

    @RequestMapping(value = "/Exploit/Find/Port/{port}")
    public List<Exploit> searchExploitByPort(@PathVariable int port){
        return exploitController.getExploitsByPort(port);
    }

    @RequestMapping(value = "/Paper/Find/{language}/{tags}")
    public List<Exploit> searchExploitByPaperAndLanguage(@PathVariable("language") String language, @PathVariable("tags") String tags) {
        List<String> soloTags = splitTags(tags);
        if (soloTags.size() > 1) {
            throw new NotImplementedException();
        }
        return exploitController.searchPaperByLanguageAndTags(language, soloTags.get(0));
    }

    @RequestMapping(value = "/Paper/Language/{language}")
    public List<Exploit> searchExploitByPaperAndLanguage(@PathVariable String language) {
        return exploitController.getPaperByLanguage(language);
    }

    @RequestMapping(value = "/Paper/Author/{author}")
    public List<Exploit> searchExploitByPaperAndAuthor(@PathVariable String author){
        return exploitController.getPaperByAuthor(author);
    }

    private List<String> splitTags(String unsplittedTags) {
        return Arrays.asList(unsplittedTags.split(","));
    }
}
