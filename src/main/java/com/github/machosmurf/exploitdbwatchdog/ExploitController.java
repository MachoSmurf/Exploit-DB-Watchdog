package com.github.machosmurf.exploitdbwatchdog;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;

@Component
public class ExploitController {

    private ExploitRepository exploitRepository;

    @Autowired
    public ExploitController(ExploitRepository exploitRepository){
        this.exploitRepository = exploitRepository;

    }

    public Exploit getExploitById(int exploitID) {
        return exploitRepository.findByExploitID(exploitID);
    }

    public List<Exploit> getExploitsByAuthor(String author) {
        return exploitRepository.findByGeneralTypeAndAuthor(GeneralType.Exploit, author);
    }

    public List<Exploit> getExploitsByType(String type) {
        return exploitRepository.findExploitsByType(type);
    }

    public List<Exploit> getExploitsByPlatform(String platform) {
        return exploitRepository.findByPlatform(platform);
    }

    public List<Exploit> getExploitsByPlatformAndTags(String platform, List<String> tagSet) {
        ArrayList<List<Exploit>> subsets = new ArrayList<>();
        for(String tag : tagSet){
            subsets.add(exploitRepository.findByPlatformAndDescriptionContaining(platform, tag));
        }

        List<Exploit> filteredSet = filterResult(subsets, true, tagSet);

        return filteredSet;
    }

    public List<Exploit> getExploitsByPort(int port) {
        return exploitRepository.findByPort(port);
    }

    public List<Exploit> searchPaperByLanguageAndTags(String language, String tag) {
        return exploitRepository.findByLanguageAndDescriptionContaining(language, tag);
    }

    public List<Exploit> getPaperByLanguage(String language) {
        return exploitRepository.findByLanguage(language);
    }

    public List<Exploit> getPaperByAuthor(String author) {
        return exploitRepository.findByGeneralTypeAndAuthor(GeneralType.Paper, author);
    }

    public List<Exploit> searchExploitByTags(List<String> tags) {
        ArrayList<List<Exploit>> subsets = new ArrayList<>();
        for(String tag : tags){
             subsets.add(exploitRepository.findByGeneralTypeAndDescriptionContaining(GeneralType.Exploit, tag));
        }

        List<Exploit> filteredSet = filterResult(subsets, true, tags);

        return filteredSet;
    }

    private List<Exploit> filterResult(List<List<Exploit>> resultSets, boolean andOperator, List<String> tagSet){
        //if andOperator is true, make sure the filtered results contain ALL tags. if false treat as OR, making sure
        //result only contains ONE of the tags
        ArrayList<Exploit> finalSet = new ArrayList<>();

        for(List<Exploit> subset : resultSets){
            for(Exploit exploit : subset){
                if (andOperator){
                    boolean containsAll = true;
                    for(String tag : tagSet){
                        if (!exploit.getDescription().toLowerCase().contains(tag.toLowerCase())){
                            containsAll = false;
                        }
                    }

                    if (containsAll){
                        //check if allready in the finalset
                        if (!finalSet.contains(exploit)){
                            finalSet.add(exploit);
                        }
                    }
                }
                else{
                    int tagsFound = 0;
                    for(String tag : tagSet){
                        if (exploit.getDescription().contains(tag)){
                            tagsFound++;
                        }
                    }
                    if(tagsFound == 1){
                        if (!finalSet.contains(exploit)){
                            finalSet.add(exploit);
                        }
                    }
                }
            }
        }

        return finalSet;
    }

    public List<Language> getLanguageCount() {
        List<Language> langList = exploitRepository.findLanguageCount();
        return langList;
    }

    public List<Port> getPortCount(){
        List<Port> portList = exploitRepository.findPortCount();
        return portList;
    }

    public List<Platform> getPlatformCount(){
        List<Platform> platformList = exploitRepository.findPlatformCount();
        return platformList;
    }

    public List<Type> getTypeCount(){
        List<Type> typeList = exploitRepository.findTypeCount();
        return typeList;
    }
}
